---
title: "COVID-19 Canada"
output: 
  flexdashboard::flex_dashboard:
    css: style.css
    social: menu
    # source_code: embed
    orientation: columns
    vertical_layout: scroll
    theme: flatly
    includes:
      after_body: footer.html
runtime: shiny
---

```{r setup, echo=FALSE,results='hide',message = FALSE, warning = FALSE}
#------------------ Packages ------------------
library(shiny) #shiny app;
library(flexdashboard) #dashboard;
library(dplyr) #data tool;
library(RCurl) #read data url;
library(plotly) #visual tool;
library(tibble) #scrap variable characters;
library(DT) #Datatable;


#------------------ Read Canada data ------------------
#read raw github data;
x1 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/timeseries_prov/cases_timeseries_prov.csv") #new time series data, apr13;
x2 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/timeseries_prov/mortality_timeseries_prov.csv") #new time series data, apr13;
x3 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/recovered_cumulative.csv")
x4 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/testing_cumulative.csv")

can_c <- read.csv(text=x1, header = TRUE, sep = ",", encoding = 'UTF-8')
can_d <- read.csv(text=x2, header = TRUE, sep = ",", encoding = 'UTF-8')
can_r <- read.csv(text=x3, header = TRUE, sep = ",", encoding = 'UTF-8')
can_t <- read.csv(text=x4, header = TRUE, sep = ",", encoding = 'UTF-8')

`%>%` <- magrittr::`%>%`
#------------------ canada data formating ------------------
#format dates;
can_c$date_report<-as.Date(can_c$date_report,format="%d-%m-%y")
can_d$date_death_report<-as.Date(can_d$date_death_report,format="%d-%m-%y")
can_r$date_recovered<-as.Date(can_r$date_recovered,format="%d-%m-%y")
can_t$date_testing<-as.Date(can_t$date_testing,format="%d-%m-%y")

#format province labels;
province_labelc<-c("Alberta","British Columbia","Manitoba","New Brunswick", "Newfoundland and Labrador", "Nova Scotia","Nunavut","NorthWest", "Ontario","Prince Edward Island","Quebec", "Repatriated","Saskatchewan","Yukon")
province_labeld<-c("Alberta","British Columbia","Manitoba","New Brunswick", "Newfoundland and Labrador", "Nova Scotia","Nunavut","NorthWest", "Ontario","Prince Edward Island","Quebec","Saskatchewan","Yukon")

levels(can_c$province)<-province_labelc
levels(can_d$province)<-province_labeld
levels(can_r$province)<-province_labeld
levels(can_t$province)<-province_labeld

#aggregate counts by date combining all province;
can_c_daily <- can_c  %>% group_by(date_report) %>% summarise(c_daily=sum(cases, na.rm = T)) 
can_d_daily <- can_d  %>% group_by(date_death_report) %>% summarise(d_daily=sum(deaths, na.rm = T)) 
can_r_daily <- can_r  %>% group_by(date_recovered) %>% summarise(r_cum=sum(cumulative_recovered, na.rm = T)) 
can_t_daily <- can_t  %>% group_by(can_t$date_testing) %>% summarise(t_cum=sum(cumulative_testing, na.rm=T)) 

#merge all data by dates in a canada dataset;
#this data can be shared on the dashboard; #we can also share the canada data by province;
can<-merge(can_c_daily, can_d_daily, by.x = "date_report",by.y="date_death_report",all.x = T)
can<-merge(can, can_r_daily, by.x = "date_report",by.y="date_recovered",all.x = T)
can<-merge(can, can_t_daily, by.x = "date_report", by.y="can_t$date_testing",all.x = T)
can[is.na(can)]<-0  #give value zero for missing;

can <- can %>% mutate(c_cum = cumsum(c_daily)) #cumulative level;
can <- can %>% mutate(d_cum = cumsum(d_daily)) #cumulative level;
can$a_cum<-can$c_cum - can$r_cum - can$d_cum


#getting daily recovered;
can$r_lag<-lag(can$r_cum)
can$r_lag[is.na(can$r_lag)]<-0
can$r_daily<-can$r_cum-can$r_lag


`%>%` <- magrittr::`%>%`
#------------World data this is for the trajectory plot------------

world <- read.csv("https://raw.githubusercontent.com/Kuan-Liu/coronavirus-csv/master/coronavirus_clean.csv", header = TRUE, sep = ",", encoding = 'UTF-8')

df_us <- world %>% dplyr::filter( Country.Region == "US") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(us = cumsum(cases)) %>%
  dplyr::filter(us > 100)  %>%
  dplyr::select(-cases, -date)

df_us$index <- 1:nrow(df_us)


df_uk <- world %>% dplyr::filter( Country.Region == "United Kingdom") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(uk = cumsum(cases)) %>%
  dplyr::filter(uk > 100)  %>%
  dplyr::select(-cases, -date)

df_uk$index <- 1:nrow(df_uk)

df_au <- world %>% dplyr::filter( Country.Region == "Australia") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(au = cumsum(cases)) %>%
  dplyr::filter(au > 100)  %>%
  dplyr::select(-cases, -date)

df_au$index <- 1:nrow(df_au)

df_ge <- world %>% dplyr::filter( Country.Region == "Germany") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(ge = cumsum(cases)) %>%
  dplyr::filter(ge > 100)  %>%
  dplyr::select(-cases, -date)

df_ge$index <- 1:nrow(df_ge)

df_sp <- world %>% dplyr::filter( Country.Region == "Spain") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(sp = cumsum(cases)) %>%
  dplyr::filter(sp > 100)  %>%
  dplyr::select(-cases, -date)

df_sp$index <- 1:nrow(df_sp)


df_it <- world %>% dplyr::filter( Country.Region == "Italy") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(it = cumsum(cases)) %>%
  dplyr::filter(it > 100)  %>%
  dplyr::select(-cases, -date)

df_it$index <- 1:nrow(df_it)

df_sw <- world %>% dplyr::filter( Country.Region == "Switzerland") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(sw = cumsum(cases)) %>%
  dplyr::filter(sw > 100)  %>%
  dplyr::select(-cases, -date)

df_sw$index <- 1:nrow(df_sw)


#------------Canada data this is for the trajectory plot------------
c_cum<- can$c_cum[can$c_cum>100]
df_can<-data.frame(c_cum[complete.cases(c_cum)], 1:length(c_cum[complete.cases(c_cum)]))
names(df_can)<-c("can","index")

df_trajectory <- df_it %>% 
  dplyr::left_join(df_us, by = "index") %>%
  dplyr::left_join(df_can, by = "index") %>%
  dplyr::left_join(df_uk, by = "index") %>%
  dplyr::left_join(df_ge, by = "index") %>%
  dplyr::left_join(df_sw, by = "index") %>%
  dplyr::left_join(df_sp, by = "index") %>%
  dplyr::left_join(df_au, by = "index") 

#------------provincial data this is for province the trajectory plot------------
#now getting data for provinces, only those with more than 50 cases;

ab_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="Alberta")  %>% dplyr::select(cumulative_cases)
ab_cum$index <- 1:nrow(ab_cum)  
names(ab_cum)[1]<-"ab"

bc_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="British Columbia")  %>% dplyr::select(cumulative_cases)
bc_cum$index <- 1:nrow(bc_cum)  
names(bc_cum)[1]<-"bc"

on_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="Ontario")  %>% dplyr::select(cumulative_cases)
on_cum$index <- 1:nrow(on_cum)  
names(on_cum)[1]<-"on"

qc_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="Quebec")  %>% dplyr::select(cumulative_cases)
qc_cum$index <- 1:nrow(qc_cum)  
names(qc_cum)[1]<-"qc"

mb_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="Manitoba")  %>% dplyr::select(cumulative_cases)
mb_cum$index <- 1:nrow(mb_cum)  
names(mb_cum)[1]<-"mb"

nb_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="New Brunswick")  %>% dplyr::select(cumulative_cases)
nb_cum$index <- 1:nrow(nb_cum)  
names(nb_cum)[1]<-"nb"

nl_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="Newfoundland and Labrador")  %>% dplyr::select(cumulative_cases)
nl_cum$index <- 1:nrow(nl_cum)  
names(nl_cum)[1]<-"nl"

ns_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="Nova Scotia")  %>% dplyr::select(cumulative_cases)
ns_cum$index <- 1:nrow(ns_cum)  
names(ns_cum)[1]<-"ns"

sk_cum<- dplyr::filter(can_c, cumulative_cases > 50 & province=="Saskatchewan")  %>% dplyr::select(cumulative_cases)
sk_cum$index <- 1:nrow(sk_cum)  
names(sk_cum)[1]<-"sk"

df_trajectory_can <- df_can %>% 
  dplyr::left_join(on_cum, by = "index") %>%
  dplyr::left_join(qc_cum, by = "index") %>%
  dplyr::left_join(ab_cum, by = "index") %>%
  dplyr::left_join(bc_cum, by = "index") %>%
  dplyr::left_join(ns_cum, by = "index") %>%
  dplyr::left_join(sk_cum, by = "index") %>%
  dplyr::left_join(nl_cum, by = "index") %>%
  dplyr::left_join(mb_cum, by = "index") %>%
  dplyr::left_join(nb_cum, by = "index") 


`%>%` <- magrittr::`%>%`
#------------Marc Olivier plots data prep ------------
can_p<-merge(can_c, can_d[,c("province","date_death_report","deaths")], 
             by.x = c("date_report","province"),
             by.y=c("date_death_report","province"), all.x = T)

can_p[is.na(can_p)]<-0 #only do this on daily value;
# can_p <- can_p  %>% group_by(province) %>% mutate(c_cum = cumsum(c_daily)) #cumulative level;
can_p <- can_p  %>% group_by(province) %>% mutate(d_cum = cumsum(deaths)) #cumulative level;

can_p<-merge(can_p, can_r, 
             by.x = c("date_report","province"),
             by.y=c("date_recovered","province"), all = T)
can_p[is.na(can_p)]<-0 

can_p<-merge(can_p, can_t[,c("date_testing","province","cumulative_testing")], 
             by.x = c("date_report","province"),
             by.y=c("date_testing","province"), all = T)

can_p[is.na(can_p)]<-0

names(can_p)[3:8]<-c("c_daily","c_cum","d_daily","d_cum","r_cum","t_cum")


#------------------ Parameters colours  ------------------
# Set colors
# https://www.w3.org/TR/css-color-3/#svg-color

#value box colour;
tested_color <- "#00008B"
positive_color <- "#DC143C"
active_color <- "#1E90FF"
recovered_color <- "forestgreen"
death_color <- "#FF0000"
ab_color<-"#000000"
bc_color<-"#E69F00"
mb_color<-"#800000"
nb_color<-"#CC79A7"
nl_color<-"#56B4E9"
ns_color<-"#808000"
nt_color<-"#625D5D"
nu_color<-"#1589FF"
on_color<-"#009E73"
pe_color<-"#0000A0"
qc_color<-"#0072B2"
sk_color<-"#800080"
yt_color<-"#E56717"


#------------------ creating Ontario data;  ------------------

on<-can_p[can_p$province=="Ontario",]
on$a_cum<-on$c_cum - on$r_cum - on$d_cum

#getting daily recovered;
on$r_lag<-lag(on$r_cum)
on$r_lag[is.na(on$r_lag)]<-0
on$r_daily<-on$r_cum-on$r_lag

on$c_lag<-lag(on$c_cum)
on$d_lag<-lag(on$d_cum)
on$c_lag[is.na(on$c_lag)]<-0
on$d_lag[is.na(on$d_lag)]<-0

on$c_percentchange<-round(on$c_daily/on$c_lag*100,1)
on$d_percentchange<-round(on$d_daily/on$d_lag*100,1)
on$r_percentchange<-round(on$r_daily/on$r_lag*100,1)

on <- on %>% 
  dplyr::mutate(c_daily_smooth = (c_daily +
                                    dplyr::lag(c_daily, n = 1) +
                                    dplyr::lag(c_daily, n = 2) +
                                    dplyr::lag(c_daily, n = 3) +
                                    dplyr::lag(c_daily, n = 4)) / 5) %>%
  dplyr::mutate(d_daily_smooth = (d_daily +
                                    dplyr::lag(d_daily, n = 1) +
                                    dplyr::lag(d_daily, n = 2) +
                                    dplyr::lag(d_daily, n = 3) +
                                    dplyr::lag(d_daily, n = 4)) / 5) %>%
  dplyr::mutate(r_daily_smooth = (r_daily +
                                    dplyr::lag(r_daily, n = 1) +
                                    dplyr::lag(r_daily, n = 2) +
                                    dplyr::lag(r_daily, n = 3) +
                                    dplyr::lag(r_daily, n = 4)) / 5)

# 0. Health region data - all of this is for the heatmaps;
hr_c <- read.csv("https://raw.githubusercontent.com/Kuan-Liu/coronavirus-csv/master/hr_c_clean.csv", header = TRUE, sep = ",", encoding = 'UTF-8')
hr_d <- read.csv("https://raw.githubusercontent.com/Kuan-Liu/coronavirus-csv/master/hr_d_clean.csv", header = TRUE, sep = ",", encoding = 'UTF-8')

hr_c$date_report<-as.Date(hr_c$date_report,format="%d-%m-%y")
hr_d$date_death_report<-as.Date(hr_d$date_death_report,format="%d-%m-%y")

# 1. Cases
on_case<- filter(hr_c, province == "Ontario" ) 

on_case_region<- filter(hr_c, province == "Ontario" )  %>% group_by(health_region) %>% summarise(Freq=sum(cases,na.rm = T))
region_order <- unlist(on_case_region[order(on_case_region$Freq),][,1]) #save new region order by total case

on_case$health_region<-factor(on_case$health_region, levels = region_order[1:nrow(on_case_region)])

# 2. deaths
on_death<- filter(hr_d, province == "Ontario" ) 

on_death_region<- filter(hr_d, province == "Ontario" )  %>% group_by(health_region) %>% summarise(Freq=sum(deaths,na.rm = T))
region_order <- unlist(on_death_region[order(on_death_region$Freq),][,1]) #save new region order by total case

on_death$health_region<-factor(on_death$health_region, levels = region_order[1:nrow(on_case_region)])


#------------------ creating Toronto data;  ------------------

#aggregate counts by date;
trt_c_daily <- filter(hr_c, health_region=="Toronto")  %>% group_by(date_report) %>% select(-cumulative_cases, -province)
trt_d_daily <- filter(hr_d, health_region=="Toronto")  %>% group_by(date_death_report) %>% select(-cumulative_deaths, -province)

#this data can be shared on the dashboard; #we can also share the canada data by province;
trt<-merge(trt_c_daily, trt_d_daily, by.x = c("date_report", "health_region"),by.y=c("date_death_report","health_region"),all.x = T)

trt[is.na(trt)]<-0  #give value zero for missing; only do this on daily value!
names(trt)[3:4]<-c("c_daily","d_daily")

trt <- trt %>% mutate(c_cum = cumsum(c_daily)) #cumulative level;
trt <- trt %>% mutate(d_cum = cumsum(d_daily)) #cumulative level;
trt$a_cum <- trt$c_cum - trt$d_cum

df_trt<-data.frame(trt$c_cum[trt$c_cum>50], c(1:length(trt$c_cum[trt$c_cum>50])))
names(df_trt)<-c("trt","index")

df_trajectory_can <- df_trajectory_can %>% dplyr::left_join(df_trt, by = "index")
 
#------------------ creating quebec data;  ------------------

qc<-can_p[can_p$province=="Quebec",]
qc$a_cum<-qc$c_cum - qc$r_cum - qc$d_cum


#getting daily recovered;
qc$r_lag<-lag(qc$r_cum)
qc$r_lag[is.na(qc$r_lag)]<-0
qc$r_daily<-qc$r_cum-qc$r_lag

qc$c_lag<-lag(qc$c_cum)
qc$d_lag<-lag(qc$d_cum)
qc$c_lag[is.na(qc$c_lag)]<-0
qc$d_lag[is.na(qc$d_lag)]<-0

qc$c_percentchange<-round(qc$c_daily/qc$c_lag*100,1)
qc$d_percentchange<-round(qc$d_daily/qc$d_lag*100,1)
qc$r_percentchange<-round(qc$r_daily/qc$r_lag*100,1)

qc <- qc %>% 
  dplyr::mutate(c_daily_smooth = (c_daily +
                                    dplyr::lag(c_daily, n = 1) +
                                    dplyr::lag(c_daily, n = 2) +
                                    dplyr::lag(c_daily, n = 3) +
                                    dplyr::lag(c_daily, n = 4)) / 5) %>%
  dplyr::mutate(d_daily_smooth = (d_daily +
                                    dplyr::lag(d_daily, n = 1) +
                                    dplyr::lag(d_daily, n = 2) +
                                    dplyr::lag(d_daily, n = 3) +
                                    dplyr::lag(d_daily, n = 4)) / 5) %>%
  dplyr::mutate(r_daily_smooth = (r_daily +
                                    dplyr::lag(r_daily, n = 1) +
                                    dplyr::lag(r_daily, n = 2) +
                                    dplyr::lag(r_daily, n = 3) +
                                    dplyr::lag(r_daily, n = 4)) / 5)


# 1. Cases
qc_case<- filter(hr_c, province == "Quebec" ) 

qc_case_region<- filter(hr_c, province == "Quebec" )  %>% group_by(health_region) %>% summarise(Freq=sum(cases,na.rm = T))
region_order <- unlist(qc_case_region[order(qc_case_region$Freq),][,1]) #save new region order by total case

qc_case$health_region<-factor(qc_case$health_region, levels = region_order[1:nrow(qc_case_region)])

# 2. deaths
qc_death<- filter(hr_d, province == "Quebec" ) 

qc_death_region<- filter(hr_d, province == "Quebec" )  %>% group_by(health_region) %>% summarise(Freq=sum(deaths,na.rm = T))
region_order <- unlist(qc_death_region[order(qc_death_region$Freq),][,1]) #save new region order by total case

qc_death$health_region<-factor(qc_death$health_region, levels = region_order[1:nrow(qc_case_region)])



#------------------ creating map data;  ------------------

library(rgdal)
library(leaflet) #mapping;

canada_prov <- rgdal::readOGR(dsn = "docs/shape/canada.geojson")

canada_region<- can_p[can_p$date_report==max(can_p$date_report)&can_p$province != "Repatriated",]
canada_region$a_cum<-canada_region$c_cum - canada_region$d_cum - canada_region$r_cum
names(canada_region)[4]<-"Cumulative Cases"


canada_region$province<-factor(canada_region$province)

levels(canada_region$province)<-c("Alberta","British Columbia","Manitoba","New Brunswick", "Newfoundland and Labrador", "Nova Scotia","Nunavut","Northwest Territories", "Ontario","Prince Edward Island","Quebec", "Saskatchewan","Yukon Territory")

canada_prov<-merge(canada_prov, canada_region[,c("province","Cumulative Cases")], by.x="name", by.y="province")

#------------------ data update time;  ------------------

date_update_date<-read.table("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/update_time.txt")
data_date<-as_tibble(paste(date_update_date$V1, date_update_date$V2, date_update_date$V3))


```


Summary {data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------
### tested {.value-box}
```{r}
valueBox(value = paste(format(max(can$t_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Tested Cases", 
         icon = "fas fa-user-md", 
         color = tested_color)
```



### Positive Cases {.value-box}

```{r}
valueBox(value = paste(format(max(can$c_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Positive", 
         icon = "far fa-plus-square", 
         color = positive_color)
```


### Active {.value-box}
```{r}
valueBox(value = paste(format(max(can$a_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Active Cases", 
         icon = "fas fa-ambulance",
         color = active_color)
```

### recovered {.value-box}
```{r}
valueBox(value = paste(format(max(can$r_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Recovered Cases", 
         icon = "fas fa-heartbeat", 
         color = recovered_color)
```

### death {.value-box}
```{r}
valueBox(value = paste(format(max(can$d_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Deaths", 
         icon = "", 
         color = death_color)
```

Row
-----------------------------------------------------------------------

### Overall Distribution of Cases

```{r}
plotly::plot_ly(data = can[can$date_report > as.Date("2020-02-29"),],
        x = ~ date_report,
        y = ~ a_cum, 
        name = 'Active', 
        fillcolor = '#1f77b4',
        type = 'scatter',
        mode = 'none', 
        stackgroup = 'one') %>%
  plotly::add_trace( y = ~ d_cum, 
             name = "Death",
             fillcolor = '#E41317') %>%
  plotly::add_trace(y = ~ r_cum, 
            name = 'Recovered', 
            fillcolor = 'forestgreen') %>%
  plotly::layout(title = "",
         legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = ""),
         yaxis = list(title = "Number of Cumulative Cases"),
         hovermode = "compared")
```

### Trajectory of Confirmed Cases in Canada Comparing to Other Countries

```{r}

plotly::plot_ly(data = df_trajectory) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ can,
                    name = "Canada",  line = list(width = 4,color = "red")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ us,
                    line = list(color = "black", width = 2),
                    name = "United States") %>%
   plotly::add_lines(x = ~ index,
                    y = ~ sp,
                    line = list(color = "#ff8c00", width = 2),
                    name = "Spain") %>%
   plotly::add_lines(x = ~ index,
                    y = ~ it,
                    line = list(color = "#ec008c", width = 2),
                    name = "Italy") %>%
   plotly::add_lines(x = ~ index,
                    y = ~ ge,
                    line = list(color = "#00188f", width = 2),
                    name = "Germany") %>%
   plotly::add_lines(x = ~ index,
                    y = ~ uk,
                    name = "United Kingdom",  line = list(width = 2,color = "green")) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ sw,
                    line = list(color = "#00bcf2", width = 2),
                    name = "Switzerlands") %>%
   plotly::add_lines(x = ~ index,
                    y = ~ au,
                    line = list(color = "brown", width = 2),
                    name = "Australia") %>%
   plotly::layout(yaxis = list(title = "Cumulative Positive Cases (log-scale)",type = "log"),
                 xaxis = list(title = "Days since the total positive cases surpass 100"))

```


Row
-----------------------------------------------------------------------

### Distribution of Daily New Confirmed, Fatal and Recovered Cases

```{r}
can <- can %>% 
  dplyr::mutate(c_daily_smooth = (c_daily +
                                    dplyr::lag(c_daily, n = 1) +
                                    dplyr::lag(c_daily, n = 2) +
                                    dplyr::lag(c_daily, n = 3) +
                                    dplyr::lag(c_daily, n = 4)) / 5) %>%
  dplyr::mutate(d_daily_smooth = (d_daily +
                                    dplyr::lag(d_daily, n = 1) +
                                    dplyr::lag(d_daily, n = 2) +
                                    dplyr::lag(d_daily, n = 3) +
                                    dplyr::lag(d_daily, n = 4)) / 5) %>%
  dplyr::mutate(r_daily_smooth = (r_daily +
                                    dplyr::lag(r_daily, n = 1) +
                                    dplyr::lag(r_daily, n = 2) +
                                    dplyr::lag(r_daily, n = 3) +
                                    dplyr::lag(r_daily, n = 4)) / 5)

plot_ly(can[can$date_report>as.Date("2020-03-01"),], x = ~ date_report, y = ~c_daily, type="scatter", mode = 'markers',  name = 'Daily New Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(x = ~ date_report, y = ~ c_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Case Trend', line = list(color = '#1f77b4',width=2), marker = list(color = '#1f77b4', opacity=0)) %>% 
  add_trace(y = ~d_daily, name = 'Daily New Death', marker = list(color = 'red'), mode = 'markers') %>% 
  add_trace(x = ~ date_report, y = ~ d_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Fatal Trend', line = list(color = 'red',width=2), marker = list(color = 'red', opacity=0)) %>% 
  add_trace(y = ~r_daily, name = 'Daily New Recovered', marker = list(color = 'forestgreen'), mode = 'markers') %>% 
  add_trace(y = ~r_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Recovery Trend',line = list(color = 'forestgreen',width=2), marker = list(color = 'forestgreen', opacity=0))  %>% 
  plotly::layout(title = "", legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = "Using 5 days trailing moving average to calculate the trend lines"),
         yaxis = list(title = "Number of New Daily Cases"))

```


### Daily Percentage Increase on Confirmed and Fatal Cases


```{r}
can$c_lag<-lag(can$c_cum)
can$d_lag<-lag(can$d_cum)
can$c_lag[is.na(can$c_lag)]<-0
can$d_lag[is.na(can$d_lag)]<-0

can$c_percentchange<-round(can$c_daily/can$c_lag*100,1)
can$d_percentchange<-round(can$d_daily/can$d_lag*100,1)
can$r_percentchange<-round(can$r_daily/can$r_lag*100,1)


plot_ly(can[can$date_report>as.Date("2020-03-01"),], x = ~ date_report, y = ~c_percentchange, type="scatter", mode = 'lines+markers',  name = '% Change Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(y = ~d_percentchange, name = '% Change Death', marker = list(color = 'red'), line=list(color="red"),mode = 'lines+markers') %>% 
  plotly::layout(title = "", xaxis = list(title = ""), legend = list(x = 0.7, y = 0.95),
         yaxis = list(title = "Percentage change in Cases"))

```


Row
-----------------------------------------------------------------------

### Marc's Distribution of Confirmed Cases by Province and Territory

```{r}
can_c_mo<- can_p[can_p$date_report>as.Date("2020-02-29"),c("date_report","province","c_cum")]
can_c_mo<- reshape(can_c_mo, idvar = "date_report",timevar="province",direction = "wide")

names(can_c_mo)[2:ncol(can_c_mo)]<-sub("c.cum.", "", names(can_c_mo)[2:ncol(can_c_mo)])
can_c_mo[is.na(can_c_mo)]<-0

plot_ly(can_c_mo, x = ~date_report, y = ~Quebec, name = 'Quebec', type = 'scatter', mode = 'none', stackgroup = 'one', groupnorm = 'percent', fillcolor = qc_color) %>% 
  add_trace(y = ~Ontario, name = 'Ontario', fillcolor = on_color) %>% 
  add_trace(y = ~`British Columbia`, name = 'British Columbia', fillcolor = bc_color) %>% 
  add_trace(y = ~Alberta, name = 'Alberta', fillcolor = ab_color) %>% 
  add_trace(y = ~`Nova Scotia`, name = 'Nova Scotia', fillcolor = ns_color) %>% 
  add_trace(y = ~Saskatchewan, name = 'Saskatchewan', fillcolor = sk_color) %>% 
  add_trace(y = ~Manitoba, name = 'Manitoba', fillcolor = mb_color) %>% 
  add_trace(y = ~`Newfoundland and Labrador`, name = 'Newfoundland and Labrador', fillcolor = nl_color) %>%
  add_trace(y = ~`New Brunswick`, name = 'New Brunswick', fillcolor = nb_color) %>% 
  add_trace(y = ~`Prince Edward Island`, name = 'Prince Edward Island', fillcolor = pe_color) %>% 
  add_trace(y = ~Repatriated, name = 'Repatriated', fillcolor = "lightgrey") %>% 
  add_trace(y = ~Yukon, name = 'Yukon', fillcolor = yt_color) %>% 
  add_trace(y = ~NorthWest, name = 'NorthWest', fillcolor = nt_color) %>% 
  layout(xaxis = list(title = "",showgrid = FALSE),
         yaxis = list(title = "Proportion from the Total",
         showgrid = FALSE, ticksuffix = '%'),hovermode = "compared")

```


### Marc's Distribution of Fatal Cases by Province and Territory

```{r}
can_d_mo<- can_p[can_p$date_report>as.Date("2020-03-07"),c("date_report","province","d_cum")]
can_d_mo<- reshape(can_d_mo, idvar = "date_report",timevar="province",direction = "wide")

names(can_d_mo)[2:ncol(can_d_mo)]<-sub("d.cum.", "", names(can_d_mo)[2:ncol(can_d_mo)])
can_d_mo[is.na(can_d_mo)]<-0

plot_ly(can_d_mo, x = ~date_report, y = ~Quebec, name = 'Quebec', type = 'scatter', mode = 'none', stackgroup = 'one', groupnorm = 'percent', fillcolor = qc_color) %>% add_trace(y = ~Ontario, name = 'Ontario', fillcolor = on_color) %>%
  add_trace(y = ~`British Columbia`, name = 'British Columbia', fillcolor = bc_color) %>% 
  add_trace(y = ~Alberta, name = 'Alberta', fillcolor = ab_color) %>% 
  add_trace(y = ~`Nova Scotia`, name = 'Nova Scotia', fillcolor = ns_color) %>% 
  add_trace(y = ~Saskatchewan, name = 'Saskatchewan', fillcolor = sk_color) %>% 
  add_trace(y = ~Manitoba, name = 'Manitoba', fillcolor = mb_color) %>% 
  add_trace(y = ~`Newfoundland and Labrador`, name = 'Newfoundland and Labrador', fillcolor = nl_color) %>% 
  add_trace(y = ~`New Brunswick`, name = 'New Brunswick', fillcolor = nb_color) %>% 
  add_trace(y = ~`Prince Edward Island`, name = 'Prince Edward Island', fillcolor = pe_color) %>% 
  add_trace(y = ~Repatriated, name = 'Repatriated', fillcolor = "lightgrey") %>% 
  add_trace(y = ~Yukon, name = 'Yukon', fillcolor = yt_color) %>% 
  add_trace(y = ~NorthWest, name = 'NorthWest', fillcolor = nt_color) %>% 
  layout(xaxis = list(title = "", showgrid = FALSE),
         yaxis = list(title = "Proportion from the Total",
         showgrid = FALSE, ticksuffix = '%'),hovermode = "compared")

```

Map
=======================================================================

Column {data-width=550}
-----------------------------------------------------------------------

### Geographic Mapping on Cumulative Cases in Canada

```{r}

#I have trouble deploying maps, it shows on my Rstudio document but failed everytime I try deploying it to shinyapps. Will try latter midnight, when no one is access the app.

pal <- colorNumeric("viridis", NULL)

renderLeaflet({leaflet(canada_prov) %>%
  addTiles() %>%
  addPolygons(stroke = T, smoothFactor = 0.5, opacity = 1.0,fillOpacity = 0.6,
    fillColor = ~ pal(`Cumulative Cases`),weight = 1,
    label = ~paste0(name, ": ", formatC(`Cumulative Cases`, big.mark = ",")))%>%
  addLegend(pal = pal, values = ~`Cumulative Cases`, opacity = 0.6)})


```

Column 
-----------------------------------------------------------------------

### Canada COVID-19 Data by Province and Territory as of `r data_date$value`

```{r}
DT::renderDT(canada_region[,c(2,4,9,6,7,8)] %>%
  DT::datatable(rownames = FALSE,
                colnames = c("Region","Cumulative Cases", "Cumulative Active Cases","Cumulative Deaths", "Cumulative Recovered", "Total tests completed"), options = list(order = list(1, 'desc'), searching = FALSE), filter = 'none'))
```


Toronto {data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------

### Positive Cases {.value-box}

```{r}
valueBox(value = paste(format(max(trt$c_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Positive", 
         icon = "far fa-plus-square", 
         color = positive_color)
```

### Active and Recovered Cases {.value-box}
```{r}
valueBox(value = paste(format(max(trt$a_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Active and Recovered Cases", 
         icon = "fas fa-ambulance",
         color = active_color)
```


### death {.value-box}
```{r}
valueBox(value = paste(format(max(trt$d_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Deaths", 
         icon = "", 
         color = death_color)
```

Row
-----------------------------------------------------------------------

### Overall Distribution of Cases

```{r}
plotly::plot_ly(data = trt[trt$date_report>as.Date("2020-02-29"),],
        x = ~ date_report,
        y = ~ a_cum, 
        name = 'Active and Recovered Cases', 
        fillcolor = '#1f77b4',
        type = 'scatter',
        mode = 'none', 
        stackgroup = 'one') %>%
  plotly::add_trace( y = ~ d_cum, 
             name = "Death",
             fillcolor = '#E41317') %>%
  plotly::layout(title = "",
         legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = ""),
         yaxis = list(title = "Number of Cumulative Cases"),
         hovermode = "compared")
```

### Trajectory of Confirmed Cases in Toronto 

```{r}
plotly::plot_ly(data = df_trajectory_can) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ trt,
                    name = "Toronto",  line = list(width = 4,color = "darkblue")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ qc,
                    name = "Quebec",  line = list(width = 2, color=qc_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ on,
                    name = "Ontario", line = list(width = 2, color=on_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ ab,
                    name = "Alberta",  line = list(width = 2, color=ab_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ bc,
                    name = "British Columbia",  line = list(width = 2, color=bc_color))%>%
  plotly::add_lines(x = ~ index,
                    y = ~ ns,
                    name = "Nova Scotia",  line = list(width = 2,color = ns_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ sk,
                    name = "Saskatchewan",  line = list(width = 2,color = sk_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ nl,
                    name = "Newfoundland and Labrador",  line = list(color = nl_color, width = 2))%>%
  plotly::add_lines(x = ~ index,
                    y = ~ mb,
                    name = "Manitoba",  line = list(color = mb_color, width = 2))%>%
  plotly::add_lines(x = ~ index,
                    y = ~ nb,
                    name = "New Brunswick",  line = list(color = nb_color, width = 2))%>%
  plotly::layout(yaxis = list(title = "Cumulative Positive Cases (log-scale)",type = "log"),
                 xaxis = list(title = "Days since the total positive cases surpass 50"))

```


Row
-----------------------------------------------------------------------


### Distribution of Daily New Confirmed, Fatal and Recovered Cases

```{r}
trt <- trt %>% 
  dplyr::mutate(c_daily_smooth = (c_daily +
                                    dplyr::lag(c_daily, n = 1) +
                                    dplyr::lag(c_daily, n = 2) +
                                    dplyr::lag(c_daily, n = 3) +
                                    dplyr::lag(c_daily, n = 4)) / 5) %>%
  dplyr::mutate(d_daily_smooth = (d_daily +
                                    dplyr::lag(d_daily, n = 1) +
                                    dplyr::lag(d_daily, n = 2) +
                                    dplyr::lag(d_daily, n = 3) +
                                    dplyr::lag(d_daily, n = 4)) / 5) 

plot_ly(trt[trt$date_report>as.Date("2020-02-29"),], x = ~ date_report, y = ~c_daily, type="scatter", mode = 'markers',  name = 'Daily New Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(x = ~ date_report, y = ~ c_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Case Trend', line = list(color = '#1f77b4',width=2), marker = list(color = '#1f77b4', opacity=0)) %>% 
  add_trace(y = ~d_daily, name = 'Daily New Death', marker = list(color = 'red'), mode = 'markers') %>% 
  add_trace(x = ~ date_report, y = ~ d_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Fatal Trend', line = list(color = 'red',width=2), marker = list(color = 'red', opacity=0)) %>% 
  plotly::layout(title = "", legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = "Using 5 days trailing moving average to calculate the trend lines"),
         yaxis = list(title = "Number of New Daily Cases"))

```

### Daily Percentage Increase on Confirmed and Fatal Cases

```{r}
trt$c_lag<-lag(trt$c_cum)
trt$d_lag<-lag(trt$d_cum)
trt$c_lag[is.na(trt$c_lag)]<-0
trt$d_lag[is.na(trt$d_lag)]<-0

trt$c_percentchange<-round(trt$c_daily/trt$c_lag*100,1)
trt$d_percentchange<-round(trt$d_daily/trt$d_lag*100,1)


plot_ly(trt[trt$date_report>as.Date("2020-02-29"),], x = ~ date_report, y = ~c_percentchange, type="scatter", mode = 'lines+markers',  name = '% Change Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(y = ~d_percentchange, name = '% Change Death', marker = list(color = 'red'), line=list(color="red"),mode = 'lines+markers') %>% 
  plotly::layout(title = "", xaxis = list(title = ""),
         legend = list(x = 0.7, y = 0.95),
         yaxis = list(title = "Percentage change in Cases"))


```

Ontario 
=======================================================================

Column {data-width=100} 
-------------------------------------

### tested {.value-box}
```{r}
valueBox(value = paste(format(max(on$t_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Tested Cases", 
         icon = "fas fa-user-md", 
         color = tested_color)
```


### Positive Cases {.value-box}

```{r}
valueBox(value = paste(format(max(on$c_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Positive", 
         icon = "far fa-plus-square", 
         color = positive_color)
```


### Active {.value-box}
```{r}
valueBox(value = paste(format(max(on$a_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Active Cases", 
         icon = "fas fa-ambulance",
         color = active_color)
```

### recovered {.value-box}
```{r}
valueBox(value = paste(format(max(on$r_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Recovered Cases", 
         icon = "fas fa-heartbeat", 
         color = recovered_color)
```

### death {.value-box}
```{r}
valueBox(value = paste(format(max(on$d_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Deaths", 
         icon = "", 
         color = death_color)
```


Column {data-width=380}
-------------------------------------

### Overall Distribution of Cases
    
```{r}
plotly::plot_ly(data = on[on$date_report> as.Date("2020-02-29"),],
        x = ~ date_report,
        y = ~ a_cum, 
        name = 'Active', 
        fillcolor = '#1f77b4',
        type = 'scatter',
        mode = 'none', 
        stackgroup = 'one') %>%
  plotly::add_trace( y = ~ d_cum, 
             name = "Death",
             fillcolor = '#E41317') %>%
  plotly::add_trace(y = ~ r_cum, 
            name = 'Recovered', 
            fillcolor = 'forestgreen') %>%
  plotly::layout(title = "",
         legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = ""),
         yaxis = list(title = "Number of Cumulative Cases"),
         hovermode = "compared")
```
   

### Distribution of Daily New Confirmed, Fatal and Recovered Cases

    
```{r}

plot_ly(on[on$date_report>as.Date("2020-03-01"),], x = ~ date_report, y = ~c_daily, type="scatter", mode = 'markers',  name = 'Daily New Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(x = ~ date_report, y = ~ c_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Case Trend', line = list(color = '#1f77b4',width=2), marker = list(color = '#1f77b4', opacity=0)) %>% 
  add_trace(y = ~d_daily, name = 'Daily New Death', marker = list(color = 'red'), mode = 'markers') %>% 
  add_trace(x = ~ date_report, y = ~ d_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Fatal Trend', line = list(color = 'red',width=2), marker = list(color = 'red', opacity=0)) %>% 
  add_trace(y = ~r_daily, name = 'Daily New Recovered', marker = list(color = 'forestgreen'), mode = 'markers') %>% 
  add_trace(y = ~r_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Recovery Trend',line = list(color = 'forestgreen',width=2), marker = list(color = 'forestgreen', opacity=0)) %>% 
  plotly::layout(title = "",legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = "Using 5 days trailing moving average to calculate the trend lines"),
         yaxis = list(title = "Number of New Daily Cases"))

```


### Daily Percentage Increase on Confirmed and Fatal Cases

```{r}
plot_ly(on[on$date_report>as.Date("2020-03-01"),], x = ~ date_report, y = ~c_percentchange, type="scatter", mode = 'lines+markers',  name = '% Change Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(y = ~d_percentchange, name = '% Change Death', marker = list(color = 'red'), line=list(color="red"),mode = 'lines+markers') %>% 
  plotly::layout(title = "",legend = list(x = 0.7, y = 0.95),
         xaxis = list(title = ""),
         yaxis = list(title = "Percentage change in Cases"))

```



Column 
-------------------------------------

### Heatmaps on Cumulative Cases by Regions

```{r }

plot_ly(on_case[on_case$date_report>as.Date("2020-02-29"),] , 
               x=~date_report, y=~health_region, z = ~ cumulative_cases, type = "heatmap",
               colors = "YlGnBu",zmin=0, zmax=350,
               xgap=1, ygap=1) %>% plotly::layout(showlegend=FALSE,title = "",
         xaxis = list(title = "", side="top"),
         yaxis = list(title = ""))

```   


### Heatmaps on Cumulative Deaths by Regions

```{r }

plot_ly(on_death[on_death$date_death_report>as.Date("2020-02-29"),] , 
               x=~date_death_report, y=~health_region, z = ~ cumulative_deaths, type = "heatmap",
               colors = colorRamp(c("white","red")),zmin=0,zmax=50, xgap=1, ygap=1) %>% plotly::layout(showlegend=FALSE,title = "",
         xaxis = list(title = "", side="top"),
         yaxis = list(title = ""))

```   


Quebec 
=======================================================================

Column {data-width=100} 
-------------------------------------

### tested {.value-box}
```{r}
valueBox(value = paste(format(max(qc$t_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Tested Cases", 
         icon = "fas fa-user-md", 
         color = tested_color)
```


### Positive Cases {.value-box}

```{r}
valueBox(value = paste(format(max(qc$c_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Positive", 
         icon = "far fa-plus-square", 
         color = positive_color)
```


### Active {.value-box}
```{r}
valueBox(value = paste(format(max(qc$a_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Active Cases", 
         icon = "fas fa-ambulance",
         color = active_color)
```

### recovered {.value-box}
```{r}
valueBox(value = paste(format(max(qc$r_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Recovered Cases", 
         icon = "fas fa-heartbeat", 
         color = recovered_color)
```

### death {.value-box}
```{r}
valueBox(value = paste(format(max(qc$d_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Deaths", 
         icon = "", 
         color = death_color)
```

Column {data-width=380}
-------------------------------------

### Overall Distribution of Cases
    
```{r}
qc2<-filter(qc, date_report > as.Date("2020-02-29"))
plotly::plot_ly(data = qc2,
        x = ~ date_report,
        y = ~ a_cum, 
        name = 'Active', 
        fillcolor = '#1f77b4',
        type = 'scatter',
        mode = 'none', 
        stackgroup = 'one') %>%
  plotly::add_trace( y = ~ d_cum, 
             name = "Death",
             fillcolor = '#E41317') %>%
  plotly::add_trace(y = ~ r_cum, 
            name = 'Recovered', 
            fillcolor = 'forestgreen') %>%
  plotly::layout(title = "",
         legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = ""),
         yaxis = list(title = "Number of Cumulative Cases"),
         hovermode = "compared")
```
   

### Distribution of Daily New Confirmed, Fatal and Recovered Cases

    
```{r}

plot_ly(qc[qc$date_report>as.Date("2020-03-01"),], x = ~ date_report, y = ~c_daily, type="scatter", mode = 'markers',  name = 'Daily New Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(x = ~ date_report, y = ~ c_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Case Trend', line = list(color = '#1f77b4',width=2), marker = list(color = '#1f77b4', opacity=0)) %>% 
  add_trace(y = ~d_daily, name = 'Daily New Death', marker = list(color = 'red'), mode = 'markers') %>% 
  add_trace(x = ~ date_report, y = ~ d_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Fatal Trend', line = list(color = 'red',width=2), marker = list(color = 'red', opacity=0)) %>% 
  add_trace(y = ~r_daily, name = 'Daily New Recovered', marker = list(color = 'forestgreen'), mode = 'markers') %>% 
  add_trace(y = ~r_daily_smooth, type = 'scatter', mode = 'lines+markers', name = 'Daily Recovery Trend',line = list(color = 'forestgreen',width=2), marker = list(color = 'forestgreen', opacity=0)) %>% 
  plotly::layout(title = "", legend = list(x = 0.05, y = 0.95),
         xaxis = list(title = "Using 5 days trailing moving average to calculate the trend lines"),
         yaxis = list(title = "Number of New Daily Cases"))

```

### Daily Percentage Increase on Confirmed and Fatal Cases
    
```{r}
plot_ly(qc[qc$date_report>as.Date("2020-03-01"),], x = ~ date_report, y = ~c_percentchange, type="scatter", mode = 'lines+markers',  name = '% Change Case', marker = list(color = '#1f77b4'))  %>% 
  add_trace(y = ~d_percentchange, name = '% Change Death', marker = list(color = 'red'), line=list(color="red"),mode = 'lines+markers') %>% 
  plotly::layout(title = "", legend = list(x = 0.7, y = 0.95),
         xaxis = list(title = ""), yaxis = list(title = "Percentage change in Cases"))

```


Column
-------------------------------------
    
### Heatmaps on Cumulative Cases by Regions

```{r }
plot_ly(qc_case[qc_case$date_report>as.Date("2020-02-29"),], x=~date_report, y=~health_region, z = ~ cumulative_cases, type = "heatmap", colors = "YlGnBu",zmin=0, zmax=350,
               xgap=1, ygap=1) %>% layout(showlegend=FALSE,title = "",
         xaxis = list(title = "", side="top"),
         yaxis = list(title = ""))

```   


### Heatmaps on Cumulative Deaths by Regions

```{r }
plot_ly(qc_death[qc_death$date_death_report>as.Date("2020-02-29"),] , 
               x=~date_death_report, y=~health_region, z = ~ cumulative_deaths, type = "heatmap",
               colors = colorRamp(c("white","red")),zmin=0,zmax=50, xgap=1, ygap=1) %>% layout(showlegend=FALSE,title = "",
         xaxis = list(title = "", side="top"),
         yaxis = list(title = ""))

```   


Canada Data
=======================================================================

```{r}
can[,c(1,2,3,10,6,7,4)] %>% 
  DT::datatable(rownames = FALSE,
                colnames = c("Date","Daily New Cases","Daily New Death","Daily New Recovered","Cumulative Cases", "Cumulative Death", "Cumulative Recovered"), options = list(searchHighlight = TRUE, 
                           pageLength = nrow(can)), filter = 'top')
```


About
=======================================================================


**Time of last data update:** `r data_date$value`

***News!*** I am excited to share with everyone, [Rose Garrett](https://twitter.com/rose_carrot), will be joining me to improve this dashboard. Rose is a second year PhD student in Biostatistics at DLSPH, University of Toronto, also under the supervision of [Dr. Eleanor Pullenayegum](https://twitter.com/EMPullenayegum) at Sickkids. Rose will create new visualization figures for us. Stay tuned!

**Thank you for your interest in our COVID-19 data visualization project.** There are many great COVID-19 Canada dashboards available online. We have compiled the following list to show some of the dashboards that inspired us to build this one. 

- [The COVID-19 Canada Open Data Working Groups dashboard](https://art-bd.shinyapps.io/covid19canada/) developed by [Jean-Paul R. Soucy](https://twitter.com/JPSoucy) and [Isha Berry](https://twitter.com/ishaberry2), two amazing talented students from DLSPH.

- [The Covid19 Italy dashboard](https://github.com/RamiKrispin/italy_dash) by [Rami Krispin](https://twitter.com/Rami_Krispin). Rami's Covid19 Italy dashboard was also the coding template used in creating this dashboard.

- [The Esri Canada COVID-19 Canada dashboard](https://resources-covid19canada.hub.arcgis.com/).

- [The PHAC COVID-19 Canada dashboard](https://experience.arcgis.com/experience/2f1a13ca0b29422f9b34660f0b705043/), **most accurate and reliable**.

- [The Ontario-specific COVID-19 Analysis Website](https://howsmyflattening.ca/#/analysis) which covers detailed Ontario focused COVID-19 information.

- [The Québec provincial COVID-19 dashboard](https://www.inspq.qc.ca/covid-19/donnees).

- [The Alberta provincial COVID-19 dashboard](https://covid19stats.alberta.ca/).

Last but not least, I want to give a shout-out to [Marc-Olivier Hétu](https://twitter.com/suivicovid) whom I met on Twitter. He has been scraping public COVID-19 Canada data since March and compiled an outstanding spreadsheet with graphic analysis, which he generiously shared with me. I have adopted one of Marc's special figure on this dash and named it the Marc-Olivier figure.


**Acknowledgement**

 - **Data** 
    - Canada data used in this dashboard are extracted from the data posted by the COVID-19 Canada Open Data Working Group (https://github.com/ishaberry/Covid19Canada) lead by [Jean-Paul R. Soucy](https://twitter.com/JPSoucy) and [Isha Berry](https://twitter.com/ishaberry2). Since April 1st, the working group collected and reported case and mortality data directly from Public Health Units. Thus, the case and mortality numbers reported may be higher than those from other sources, incuding the Ontario Ministry of Health. We direct readers to their dashboard website, [About the data section](https://art-bd.shinyapps.io/covid19canada/) for details.
        - **We want to express our sincere appreciation to all contributors of the COVID-19 Canada Open Data Working Group.** **Here is a list of contributors we want to pay special tribute to [Isha Berry](https://twitter.com/ishaberry2), [Jean-Paul R. Soucy](https://twitter.com/JPSoucy), [Kamal Acharya](https://twitter.com/Kamalraj_ach), [Gabrielle Brankston](https://twitter.com/GBrankston), [Vinyas Harish](https://twitter.com/VinyasHarish), Kathy Kornas, Thivya Naganathan, Lindsay Obress, [Meghan O'Neill](https://twitter.com/_MeghanONeill), [Tanya Rossi](https://twitter.com/DrTanyaRossi), [Alison Simmons](https://twitter.com/alisonesimmons), [Shelby Sturrock](https://twitter.com/shelbysturrock), Matthew Van Camp, [James E.Wright](https://twitter.com/JWright159) and Wendy Xie.**
    - World data used in this dashboard are from the R package coronavirus developed by **[Rami Krispin](https://github.com/RamiKrispin/coronavirus)** which is generated from the Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE) Coronavirus [website](https://systems.jhu.edu/research/public-health/ncov/).
 - **Dashboard R code**
    - I built this dashboard using **Rami Krispin's Covid19 Italy [dashboard](https://github.com/RamiKrispin/italy_dash)'s code** as template. Rami's code can be found on his [github page](https://github.com/RamiKrispin/covid19Italy).
 - **Special thanks** to my supervisor **[Dr. Eleanor Pullenayegum](https://twitter.com/EMPullenayegum)** at [Sickkids](http://www.sickkids.ca/AboutSickKids/Directory/People/P/Eleanor-Pullenayegum-staff-profile.html) for her support on all my COVID-19 projects! 
 
**I would not have made this bashboard if not for the work of the above team and individuals.** You can find the code of this dashboard at <https://github.com/Kuan-Liu/canada_dash>.


**Feedbacks**

Please feel free to reach me at kuan.liu@mail.utoronto.ca. You can also find me on [Twitter](https://twitter.com/KuanLiu2).



