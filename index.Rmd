---
title: "COVID-19 Canada"
output: 
  flexdashboard::flex_dashboard:
    css: style.css
    social: menu
    source_code: embed
    orientation: columns
    vertical_layout: fill
---

```{r setup, echo=FALSE,results='hide',message = FALSE, warning = FALSE}
#------------------ Packages ------------------
library(flexdashboard) #dashboard;
library(shiny) #shiny app;
library(dplyr) #data tool;
library(tidyverse) #data tool; some clash with dplyr;
library(reshape2) #data tool;
library(chron) #data tool;
library(ggplot2) #visual tool;
library(plotly) #visual tool;
library(covid19italy) #italy data;
library(remotes) #package to load github ;
library(RCurl) #read data url;
library(magrittr) #coding tool;
library(qpcR) #data tool;
# install_github("ishaberry/Covid19Canada") #COVID-19; Canada Open Data ishaberry/Covid19Canada
# can't read the working group data from repo directly;

#------------------ Read Canada data ------------------
#read raw github data;
x1 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/cases.csv")
x2 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/mortality.csv")
x3 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/recovered_cumulative.csv")
x4 <- getURL("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/testing_cumulative.csv")

can_c <- read.csv(text=x1, header = TRUE, sep = ",", encoding = 'UTF-8')
can_d <- read.csv(text=x2, header = TRUE, sep = ",", encoding = 'UTF-8')
can_r <- read.csv(text=x3, header = TRUE, sep = ",", encoding = 'UTF-8')
can_t <- read.csv(text=x4, header = TRUE, sep = ",", encoding = 'UTF-8')

`%>%` <- magrittr::`%>%`
#------------------ canada data formating ------------------
#format dates;
can_c$date_report<-as.Date(can_c$date_report,format="%d-%m-%y")
can_d$date_death_report<-as.Date(can_d$date_death_report,format="%d-%m-%y")
can_r$date_recovered<-as.Date(can_r$date_recovered,format="%d-%m-%y")
can_t$date_testing<-as.Date(can_t$date_testing,format="%d-%m-%y")

#format province labels;
province_labelc<-c("Alberta","British Columbia","Manitoba","New Brunswick", "Newfoundland and Labrador", "Nova Scotia",
                  "NorthWest", "Ontario","Prince Edward Island","Quebec",
                  "Repatriated","Saskatchewan","Yukon")
province_labeld<-c("Alberta","British Columbia","Manitoba","Newfoundland and Labrador", "Nova Scotia", "Ontario","Quebec","Saskatchewan")
province_labelr<-c("Alberta","British Columbia","Manitoba","New Brunswick", "Newfoundland and Labrador", "Nova Scotia",
                  "Nunavut","NorthWest", "Ontario","Prince Edward Island","Quebec","Saskatchewan","Yukon")

# province_labela1<-c("AB","BC","MB","NB","NL", "NS","NW", "ON","PE","QC","SK","YT")
# province_labela2<-c("AB","BC","MB","NB","NL", "NS","NW","NU", "ON","PE","QC","SK","YT")

levels(can_c$province)<-province_labelc
levels(can_d$province)<-province_labeld
levels(can_r$province)<-province_labelr
levels(can_t$province)<-province_labelr

#set colour for each provinces and territories;
teamcolour<-c("#000000","#E69F00","#800000","#CC79A7","#56B4E9","#808000","#625D5D","#1589FF","#009E73","#0000A0","#0072B2","#800080","#E56717")
teamcolour_territory<-c("#625D5D","#1589FF","#E56717")
teamcolour_province<-c("#000000","#E69F00","#800000","#CC79A7","#56B4E9","#808000","#009E73","#0000A0","#0072B2","#800080")

#aggregate counts by date;
can_c_daily <- can_c  %>% group_by(date_report) %>% summarise(c_daily=n()) #individual level;
can_c_daily <- can_c_daily %>% mutate(c_cum = cumsum(c_daily)) #cumulative level;
can_d_daily <- can_d  %>% group_by(date_death_report) %>% summarise(d_daily=n()) #individual level;
can_d_daily <- can_d_daily %>% mutate(d_cum = cumsum(d_daily)) #cumulative level;
can_r_daily <- can_r  %>% group_by(date_recovered) %>% summarise(r_cum=sum(cumulative_recovered, na.rm = T)) #cumulative level;
can_t_daily <- can_t  %>% group_by(can_t$date_testing) %>% summarise(t_cum=sum(cumulative_testing, na.rm=T)) #cumulative level;

#merge all data by dates in a canada dataset;
#this data can be shared on the dashboard;
can<-merge(can_c_daily, can_d_daily, by.x = "date_report",by.y="date_death_report",all = T)
can<-merge(can, can_r_daily, by.x = "date_report",by.y="date_recovered",all.x = T)
can<-merge(can, can_t_daily, by.x = "date_report", by.y="can_t$date_testing",all.x = T)
can[is.na(can)]<-0  #give value zero for missing;
can$a_cum<-can$c_cum - can$r_cum - can$d_cum

#first date when reached 100 cases; use this to plot for trajectories;
# can_date_100<-min(can$date_report[can$c_cum>=100],na.rm = T)



`%>%` <- magrittr::`%>%`
#------------World data this is for the trajectory plot------------

x5<-getURL("https://raw.githubusercontent.com/RamiKrispin/coronavirus-csv/master/coronavirus_dataset.csv")

world <- read.csv(text=x5, header = TRUE, sep = ",", encoding = 'UTF-8')

df_us <- world %>% dplyr::filter(type == "confirmed", Country.Region == "US") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(us = cumsum(cases)) %>%
  dplyr::filter(us > 100)  %>%
  dplyr::select(-cases, -date)


df_us$index <- 1:nrow(df_us)
# head(df_us)

df_uk <- world %>% dplyr::filter(type == "confirmed", Country.Region == "United Kingdom") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(uk = cumsum(cases)) %>%
  dplyr::filter(uk > 100)  %>%
  dplyr::select(-cases, -date)

df_uk$index <- 1:nrow(df_uk)
# head(df_uk)


df_sk <- world %>% dplyr::filter(type == "confirmed", Country.Region == "Korea, South") %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(sko = cumsum(cases)) %>%
  dplyr::filter(sko > 100)  %>%
  dplyr::select(-cases, -date)

df_sk$index <- 1:nrow(df_sk)
# head(df_sk)


`%>%` <- magrittr::`%>%`
#------------Canada data this is for the trajectory plot------------
c_cum<- can$c_cum[can$c_cum>100]
df_can<-data.frame(c_cum[complete.cases(c_cum)], 1:length(c_cum[complete.cases(c_cum)]))
names(df_can)<-c("can","index")

#now getting data for provinces, only those with more than 100 cases;
#aggregate counts by date;
can_p_c_daily <- can_c  %>% group_by(date_report,province) %>% summarise(c_daily=n()) #individual level;
can_p_c_daily <- can_p_c_daily %>% group_by(province) %>% mutate(c_cum = cumsum(c_daily)) #cumulative level;

ab_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="Alberta")  %>% dplyr::select(c_cum)
ab_cum$index <- 1:nrow(ab_cum)  

bc_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="British Columbia")  %>% dplyr::select(c_cum)
bc_cum$index <- 1:nrow(bc_cum)  

mb_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="Manitoba")  %>% dplyr::select(c_cum)
mb_cum$index <- 1:nrow(mb_cum)  

nb_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="New Brunswick")  %>% dplyr::select(c_cum)
nb_cum$index <- 1:nrow(nb_cum)  

nl_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="Newfoundland and Labrador")  %>% dplyr::select(c_cum)
nl_cum$index <- 1:nrow(nl_cum)  

ns_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="Nova Scotia")  %>% dplyr::select(c_cum)
ns_cum$index <- 1:nrow(ns_cum)  

on_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="Ontario")  %>% dplyr::select(c_cum)
on_cum$index <- 1:nrow(on_cum)  

qc_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="Quebec")  %>% dplyr::select(c_cum)
qc_cum$index <- 1:nrow(qc_cum)  

sk_cum<- dplyr::filter(can_p_c_daily, c_cum > 100 & province=="Saskatchewan")  %>% dplyr::select(c_cum)
sk_cum$index <- 1:nrow(sk_cum)  

df_trajectory <- df_sk %>% 
  dplyr::left_join(df_us, by = "index") %>%
  dplyr::left_join(df_uk, by = "index") %>%
  dplyr::left_join(df_can, by = "index") %>%
  dplyr::left_join(on_cum[,2:3], by = "index") %>%
  dplyr::left_join(qc_cum[,2:3], by = "index") %>%
  dplyr::left_join(ab_cum[,2:3], by = "index") %>%
  dplyr::left_join(bc_cum[,2:3], by = "index") %>%
  dplyr::left_join(sk_cum[,2:3], by = "index") %>%
  dplyr::left_join(nl_cum[,2:3], by = "index") %>%
  dplyr::left_join(ns_cum[,2:3], by = "index") %>%
  dplyr::left_join(mb_cum[,2:3], by = "index") %>%
  dplyr::left_join(nb_cum[,2:3], by = "index")

names(df_trajectory)[6:ncol(df_trajectory)]<-c("on","qc","ab","bc","sk","nl","ns","mb","nb")

#------------------ Parameters ------------------
# Set colors
# https://www.w3.org/TR/css-color-3/#svg-color
tested_color <- "#00008B"
positive_color <- "#DC143C"
active_color <- "#1E90FF"
recovered_color <- "forestgreen"
death_color <- "#FF0000"

```



Summary
=======================================================================
Column { data-width=150 }
-----------------------------------------------------------------------
### tested {.value-box}
```{r}
valueBox(value = paste(format(max(can$t_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Tested Cases", 
         icon = "fas fa-user-md", 
         color = tested_color)
```



### Positive Cases {.value-box}

```{r}
valueBox(value = paste(format(max(can$c_cum, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Positive Cases", 
         icon = "far fa-plus-square", 
         color = positive_color)
```


### Active {.value-box}
```{r}
valueBox(value = paste(format(max(can$a_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Active Cases", 
         icon = "fas fa-ambulance",
         color = active_color)
```

### recovered {.value-box}
```{r}
valueBox(value = paste(format(max(can$r_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Recovered Cases", 
         icon = "fas fa-heartbeat", 
         color = recovered_color)
```

### death {.value-box}
```{r}
valueBox(value = paste(format(max(can$d_cum, na.rm = T), big.mark = ","), sep = ""),
         caption = "Death Cases", 
         icon = "", 
         color = death_color)
```

Column { data-width=425 }
-----------------------------------------------------------------------

### Overall Distribution of Cases

```{r}
can2<-filter(can, date_report > as.Date("2020-02-29"))
plotly::plot_ly(data = can2,
        x = ~ date_report,
        y = ~ a_cum, 
        name = 'Active', 
        fillcolor = '#1f77b4',
        type = 'scatter',
        mode = 'none', 
        stackgroup = 'one') %>%
  plotly::add_trace( y = ~ d_cum, 
             name = "Death",
             fillcolor = '#E41317') %>%
  plotly::add_trace(y = ~ r_cum, 
            name = 'Recovered', 
            fillcolor = 'forestgreen') %>%
  plotly::layout(title = "",
         legend = list(x = 0.1, y = 0.9),
         yaxis = list(title = "Number of Cases"),
         hovermode = "compared")
```

Column { data-width=425 }
-----------------------------------------------------------------------

### Trajectory Plot on confirmed cases of Canada by provinces with more than 1000 cases

```{r}
# `%>%` <- magrittr::`%>%`
plotly::plot_ly(data = df_trajectory) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ us,
                    name = "United States",  line = list(width = 1,color = "black")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ can,
                    line = list(color = "red", width = 3),
                    name = "Canada") %>%
  plotly::add_lines(x = ~ index,
                    y = ~ uk,
                    name = "United Kingdom",  line = list(width = 1,color = "brwnyl")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ sko,
                    name = "South Korea",  line = list(color = "orange", width = 1)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ qc,
                    name = "Quebec",  line = list(width = 2, color="navy")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ on,
                    name = "Ontario", line = list(width = 2, color="emrld")) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ ab,
                    name = "Alberta",  line = list(width = 2, color="pinkyl")) %>%   
  plotly::add_lines(x = ~ index,
                    y = ~ bc,
                    name = "British Columbia",  line = list(width = 2, color="purple")) %>%
  plotly::layout(yaxis = list(title = "Cumulative Positive Cases",type = "log"),
                 xaxis = list(title = "Days since the total positive cases surpass 100"),
                 legend = list(x = 0.7, y = 0.1))


```


Ontario
=======================================================================


Canada Data
=======================================================================

```{r}
`%>%` <- magrittr::`%>%`
can[,c(1,3,5,6,7)] %>% 
  DT::datatable(rownames = FALSE,
                colnames = c("Date","Cumulative Cases", "Cumulative Death", "Cumulative Recovered", "Cumulative Testing"),
            options = list(searchHighlight = TRUE, 
                           pageLength = nrow(can)), filter = 'top')
```



About
=======================================================================
**From the author**

Thank you for your interest in my new data visualization project. There are many great COVID-19 Canada dashboards available online. I have compiled the following list to show some of the dashboards that inspired me to build this one. 

- The COVID-19 Canada Open Data Working Groups [dashboard](https://art-bd.shinyapps.io/covid19canada/) made by [Jean-Paul R. Soucy](https://twitter.com/JPSoucy) and [Isha Berry](https://twitter.com/ishaberry2), two amazing talented students from my school, DLSPH, at Univerity of Toronto.

- The Covid19 Italy [dashboard](https://github.com/RamiKrispin/italy_dash) by [Rami Krispin](https://twitter.com/Rami_Krispin). I used Rami's [R markdown code](https://github.com/RamiKrispin/covid19Italy) for this dashboard.

- The Esri Canada COVID-19 Canada [dashboard](https://resources-covid19canada.hub.arcgis.com/).

- The PHAC COVID-19 Canada [dashboard](https://experience.arcgis.com/experience/2f1a13ca0b29422f9b34660f0b705043/), **most accurate and reliable** info on Canadian COVID-19 epidemiology data.

- The Ontario-specific COVID-19 Analysis [Website](https://howsmyflattening.ca/#/analysis) which covers detailed Ontario focused analytical information on critical care analysis, health region analysis and testing analysis. This website I believe was also built by a group of University of Toronto students.

- The Alberta provincial COVID-19 [dashboard](https://covid19stats.alberta.ca/).
 
Using the four COVID-19 Canada Open Data Working Group's spreadsheets on cases, mortality, recovery and testing at <https://github.com/ishaberry/Covid19Canada>, I created an aggregated Canada COVID-19 daily data. You can view this data on the data page of this dash.


Last but not least, I want to give a shout-out to Marc-Olivier Hétu whom I met on [twitter](https://twitter.com/suivicovid). He has been scraping public COVID-19 Canada since March and compiled an outstanding spreadsheet with graphic analysis, which he generiously shared with me, because he said he's glad that more people get to use his data to build tools. I have adopted one of Marc's special figure on this dash and I named it the Marc-Olivier figure.



**Acknowledgement**

 - **Data** 
    - Canada data used in this dashboard are extracted from the data speardsheet posted by the COVID-19 Canada Open Data Working Group (https://github.com/ishaberry/Covid19Canada) lead by Jean-Paul R. Soucy and Isha Berry.
    - US data used in this dashboard are from the R package coronavirus developed by [Rami Krispin](https://github.com/RamiKrispin/coronavirus) which is generated from the Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE) Coronavirus [website](https://systems.jhu.edu/research/public-health/ncov/).
 - **Dashboard R code**
    - I built this dashboard using Rami Krispin's Covid19 Italy [dashboard](https://github.com/RamiKrispin/italy_dash)'s code as template. Rami's code can be found on this [github page](https://github.com/RamiKrispin/covid19Italy).
 
I would not have made this bashboard if not for the work of the above team and individuals. You can find the code of this dashboard at <https://github.com/Kuan-Liu/italy_dash>. I kept Rami's orignal repository name to acknowledge the source.



**Feedbacks**

Please feel free to reach me at kuan.liu@mail.utoronto.ca. You can also find me on [Twitter](https://twitter.com/KuanLiu2).




